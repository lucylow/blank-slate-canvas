"""
Map Service - GeoMatcher and Track Geometry Services
Handles map matching, track geometry, and spatial enrichment
"""
import logging
from typing import List, Dict, Optional, Tuple
from datetime import datetime
import math
from pathlib import Path

logger = logging.getLogger(__name__)

# Mock track geometry data (fallback)
MOCK_TRACK_GEOMETRY = {
    "sebring": {
        "centerline_geojson": {
            "type": "LineString",
            "coordinates": [
                [-80.3478, 27.4547], [-80.3475, 27.4550], [-80.3470, 27.4555],
                [-80.3465, 27.4560], [-80.3460, 27.4565], [-80.3455, 27.4570],
                [-80.3450, 27.4575], [-80.3445, 27.4580], [-80.3440, 27.4585],
                [-80.3435, 27.4590], [-80.3430, 27.4595], [-80.3425, 27.4600],
                [-80.3420, 27.4605], [-80.3415, 27.4610], [-80.3410, 27.4615],
                [-80.3405, 27.4620], [-80.3400, 27.4625], [-80.3395, 27.4630],
                [-80.3390, 27.4635], [-80.3385, 27.4640], [-80.3380, 27.4645],
                [-80.3375, 27.4650], [-80.3370, 27.4655], [-80.3365, 27.4660],
                [-80.3360, 27.4665], [-80.3355, 27.4670], [-80.3350, 27.4675],
                [-80.3345, 27.4680], [-80.3340, 27.4685], [-80.3335, 27.4690],
                [-80.3330, 27.4695], [-80.3325, 27.4700], [-80.3320, 27.4705],
                [-80.3315, 27.4710], [-80.3310, 27.4715], [-80.3305, 27.4720],
                [-80.3300, 27.4725], [-80.3295, 27.4730], [-80.3290, 27.4735],
                [-80.3285, 27.4740], [-80.3280, 27.4745], [-80.3275, 27.4750],
                [-80.3270, 27.4755], [-80.3265, 27.4760], [-80.3260, 27.4765],
                [-80.3255, 27.4770], [-80.3250, 27.4775], [-80.3245, 27.4780],
                [-80.3240, 27.4785], [-80.3235, 27.4790], [-80.3230, 27.4795],
                [-80.3225, 27.4800], [-80.3220, 27.4805], [-80.3215, 27.4810],
                [-80.3210, 27.4815], [-80.3205, 27.4820], [-80.3200, 27.4825],
                [-80.3195, 27.4830], [-80.3190, 27.4835], [-80.3185, 27.4840],
                [-80.3180, 27.4845], [-80.3175, 27.4850], [-80.3170, 27.4855],
                [-80.3165, 27.4860], [-80.3160, 27.4865], [-80.3155, 27.4870],
                [-80.3150, 27.4875], [-80.3145, 27.4880], [-80.3140, 27.4885],
                [-80.3135, 27.4890], [-80.3130, 27.4895], [-80.3125, 27.4900],
                [-80.3120, 27.4905], [-80.3115, 27.4910], [-80.3110, 27.4915],
                [-80.3105, 27.4920], [-80.3100, 27.4925], [-80.3095, 27.4930],
                [-80.3090, 27.4935], [-80.3085, 27.4940], [-80.3080, 27.4945],
                [-80.3075, 27.4950], [-80.3070, 27.4955], [-80.3065, 27.4960],
                [-80.3060, 27.4965], [-80.3055, 27.4970], [-80.3050, 27.4975],
                [-80.3045, 27.4980], [-80.3040, 27.4985], [-80.3035, 27.4990],
                [-80.3030, 27.4995], [-80.3025, 27.5000], [-80.3020, 27.5005],
                [-80.3015, 27.5010], [-80.3010, 27.5015], [-80.3005, 27.5020],
                [-80.3000, 27.5025], [-80.2995, 27.5030], [-80.2990, 27.5035],
                [-80.2985, 27.5040], [-80.2980, 27.5045], [-80.2975, 27.5050],
                [-80.2970, 27.5055], [-80.2965, 27.5060], [-80.2960, 27.5065],
                [-80.2955, 27.5070], [-80.2950, 27.5075], [-80.2945, 27.5080],
                [-80.2940, 27.5085], [-80.2935, 27.5090], [-80.2930, 27.5095],
                [-80.2925, 27.5100], [-80.2920, 27.5105], [-80.2915, 27.5110],
                [-80.2910, 27.5115], [-80.2905, 27.5120], [-80.2900, 27.5125],
                [-80.2895, 27.5130], [-80.2890, 27.5135], [-80.2885, 27.5140],
                [-80.2880, 27.5145], [-80.2875, 27.5150], [-80.2870, 27.5155],
                [-80.2865, 27.5160], [-80.2860, 27.5165], [-80.2855, 27.5170],
                [-80.2850, 27.5175], [-80.2845, 27.5180], [-80.2840, 27.5185],
                [-80.2835, 27.5190], [-80.2830, 27.5195], [-80.2825, 27.5200],
                [-80.2820, 27.5205], [-80.2815, 27.5210], [-80.2810, 27.5215],
                [-80.2805, 27.5220], [-80.2800, 27.5225], [-80.2795, 27.5230],
                [-80.2790, 27.5235], [-80.2785, 27.5240], [-80.2780, 27.5245],
                [-80.2775, 27.5250], [-80.2770, 27.5255], [-80.2765, 27.5260],
                [-80.2760, 27.5265], [-80.2755, 27.5270], [-80.2750, 27.5275],
                [-80.2745, 27.5280], [-80.2740, 27.5285], [-80.2735, 27.5290],
                [-80.2730, 27.5295], [-80.2725, 27.5300], [-80.2720, 27.5305],
                [-80.2715, 27.5310], [-80.2710, 27.5315], [-80.2705, 27.5320],
                [-80.2700, 27.5325], [-80.2695, 27.5330], [-80.2690, 27.5335],
                [-80.2685, 27.5340], [-80.2680, 27.5345], [-80.2675, 27.5350],
                [-80.2670, 27.5355], [-80.2665, 27.5360], [-80.2660, 27.5365],
                [-80.2655, 27.5370], [-80.2650, 27.5375], [-80.2645, 27.5380],
                [-80.2640, 27.5385], [-80.2635, 27.5390], [-80.2630, 27.5395],
                [-80.2625, 27.5400], [-80.2620, 27.5405], [-80.2615, 27.5410],
                [-80.2610, 27.5415], [-80.2605, 27.5420], [-80.2600, 27.5425],
                [-80.2595, 27.5430], [-80.2590, 27.5435], [-80.2585, 27.5440],
                [-80.2580, 27.5445], [-80.2575, 27.5450], [-80.2570, 27.5455],
                [-80.2565, 27.5460], [-80.2560, 27.5465], [-80.2555, 27.5470],
                [-80.2550, 27.5475], [-80.2545, 27.5480], [-80.2540, 27.5485],
                [-80.2535, 27.5490], [-80.2530, 27.5495], [-80.2525, 27.5500],
                [-80.2520, 27.5505], [-80.2515, 27.5510], [-80.2510, 27.5515],
                [-80.2505, 27.5520], [-80.2500, 27.5525], [-80.2495, 27.5530],
                [-80.2490, 27.5535], [-80.2485, 27.5540], [-80.2480, 27.5545],
                [-80.2475, 27.5550], [-80.2470, 27.5555], [-80.2465, 27.5560],
                [-80.2460, 27.5565], [-80.2455, 27.5570], [-80.2450, 27.5575],
                [-80.2445, 27.5580], [-80.2440, 27.5585], [-80.2435, 27.5590],
                [-80.2430, 27.5595], [-80.2425, 27.5600], [-80.2420, 27.5605],
                [-80.2415, 27.5610], [-80.2410, 27.5615], [-80.2405, 27.5620],
                [-80.2400, 27.5625], [-80.2395, 27.5630], [-80.2390, 27.5635],
                [-80.2385, 27.5640], [-80.2380, 27.5645], [-80.2375, 27.5650],
                [-80.2370, 27.5655], [-80.2365, 27.5660], [-80.2360, 27.5665],
                [-80.2355, 27.5670], [-80.2350, 27.5675], [-80.2345, 27.5680],
                [-80.2340, 27.5685], [-80.2335, 27.5690], [-80.2330, 27.5695],
                [-80.2325, 27.5700], [-80.2320, 27.5705], [-80.2315, 27.5710],
                [-80.2310, 27.5715], [-80.2305, 27.5720], [-80.2300, 27.5725],
                [-80.2295, 27.5730], [-80.2290, 27.5735], [-80.2285, 27.5740],
                [-80.2280, 27.5745], [-80.2275, 27.5750], [-80.2270, 27.5755],
                [-80.2265, 27.5760], [-80.2260, 27.5765], [-80.2255, 27.5770],
                [-80.2250, 27.5775], [-80.2245, 27.5780], [-80.2240, 27.5785],
                [-80.2235, 27.5790], [-80.2230, 27.5795], [-80.2225, 27.5800],
                [-80.2220, 27.5805], [-80.2215, 27.5810], [-80.2210, 27.5815],
                [-80.2205, 27.5820], [-80.2200, 27.5825], [-80.2195, 27.5830],
                [-80.2190, 27.5835], [-80.2185, 27.5840], [-80.2180, 27.5845],
                [-80.2175, 27.5850], [-80.2170, 27.5855], [-80.2165, 27.5860],
                [-80.2160, 27.5865], [-80.2155, 27.5870], [-80.2150, 27.5875],
                [-80.2145, 27.5880], [-80.2140, 27.5885], [-80.2135, 27.5890],
                [-80.2130, 27.5895], [-80.2125, 27.5900], [-80.2120, 27.5905],
                [-80.2115, 27.5910], [-80.2110, 27.5915], [-80.2105, 27.5920],
                [-80.2100, 27.5925], [-80.2095, 27.5930], [-80.2090, 27.5935],
                [-80.2085, 27.5940], [-80.2080, 27.5945], [-80.2075, 27.5950],
                [-80.2070, 27.5955], [-80.2065, 27.5960], [-80.2060, 27.5965],
                [-80.2055, 27.5970], [-80.2050, 27.5975], [-80.2045, 27.5980],
                [-80.2040, 27.5985], [-80.2035, 27.5990], [-80.2030, 27.5995],
                [-80.2025, 27.6000], [-80.2020, 27.6005], [-80.2015, 27.6010],
                [-80.2010, 27.6015], [-80.2005, 27.6020], [-80.2000, 27.6025],
                [-80.1995, 27.6030], [-80.1990, 27.6035], [-80.1985, 27.6040],
                [-80.1980, 27.6045], [-80.1975, 27.6050], [-80.1970, 27.6055],
                [-80.1965, 27.6060], [-80.1960, 27.6065], [-80.1955, 27.6070],
                [-80.1950, 27.6075], [-80.1945, 27.6080], [-80.1940, 27.6085],
                [-80.1935, 27.6090], [-80.1930, 27.6095], [-80.1925, 27.6100],
                [-80.1920, 27.6105], [-80.1915, 27.6110], [-80.1910, 27.6115],
                [-80.1905, 27.6120], [-80.1900, 27.6125], [-80.1895, 27.6130],
                [-80.1890, 27.6135], [-80.1885, 27.6140], [-80.1880, 27.6145],
                [-80.1875, 27.6150], [-80.1870, 27.6155], [-80.1865, 27.6160],
                [-80.1860, 27.6165], [-80.1855, 27.6170], [-80.1850, 27.6175],
                [-80.1845, 27.6180], [-80.1840, 27.6185], [-80.1835, 27.6190],
                [-80.1830, 27.6195], [-80.1825, 27.6200], [-80.1820, 27.6205],
                [-80.1815, 27.6210], [-80.1810, 27.6215], [-80.1805, 27.6220],
                [-80.1800, 27.6225], [-80.1795, 27.6230], [-80.1790, 27.6235],
                [-80.1785, 27.6240], [-80.1780, 27.6245], [-80.1775, 27.6250],
                [-80.1770, 27.6255], [-80.1765, 27.6260], [-80.1760, 27.6265],
                [-80.1755, 27.6270], [-80.1750, 27.6275], [-80.1745, 27.6280],
                [-80.1740, 27.6285], [-80.1735, 27.6290], [-80.1730, 27.6295],
                [-80.1725, 27.6300], [-80.1720, 27.6305], [-80.1715, 27.6310],
                [-80.1710, 27.6315], [-80.1705, 27.6320], [-80.1700, 27.6325],
                [-80.1695, 27.6330], [-80.1690, 27.6335], [-80.1685, 27.6340],
                [-80.1680, 27.6345], [-80.1675, 27.6350], [-80.1670, 27.6355],
                [-80.1665, 27.6360], [-80.1660, 27.6365], [-80.1655, 27.6370],
                [-80.1650, 27.6375], [-80.1645, 27.6380], [-80.1640, 27.6385],
                [-80.1635, 27.6390], [-80.1630, 27.6395], [-80.1625, 27.6400],
                [-80.1620, 27.6405], [-80.1615, 27.6410], [-80.1610, 27.6415],
                [-80.1605, 27.6420], [-80.1600, 27.6425], [-80.1595, 27.6430],
                [-80.1590, 27.6435], [-80.1585, 27.6440], [-80.1580, 27.6445],
                [-80.1575, 27.6450], [-80.1570, 27.6455], [-80.1565, 27.6460],
                [-80.1560, 27.6465], [-80.1555, 27.6470], [-80.1550, 27.6475],
                [-80.1545, 27.6480], [-80.1540, 27.6485], [-80.1535, 27.6490],
                [-80.1530, 27.6495], [-80.1525, 27.6500], [-80.1520, 27.6505],
                [-80.1515, 27.6510], [-80.1510, 27.6515], [-80.1505, 27.6520],
                [-80.1500, 27.6525], [-80.1495, 27.6530], [-80.1490, 27.6535],
                [-80.1485, 27.6540], [-80.1480, 27.6545], [-80.1475, 27.6550],
                [-80.1470, 27.6555], [-80.1465, 27.6560], [-80.1460, 27.6565],
                [-80.1455, 27.6570], [-80.1450, 27.6575], [-80.1445, 27.6580],
                [-80.1440, 27.6585], [-80.1435, 27.6590], [-80.1430, 27.6595],
                [-80.1425, 27.6600], [-80.1420, 27.6605], [-80.1415, 27.6610],
                [-80.1410, 27.6615], [-80.1405, 27.6620], [-80.1400, 27.6625],
                [-80.1395, 27.6630], [-80.1390, 27.6635], [-80.1385, 27.6640],
                [-80.1380, 27.6645], [-80.1375, 27.6650], [-80.1370, 27.6655],
                [-80.1365, 27.6660], [-80.1360, 27.6665], [-80.1355, 27.6670],
                [-80.1350, 27.6675], [-80.1345, 27.6680], [-80.1340, 27.6685],
                [-80.1335, 27.6690], [-80.1330, 27.6695], [-80.1325, 27.6700],
                [-80.1320, 27.6705], [-80.1315, 27.6710], [-80.1310, 27.6715],
                [-80.1305, 27.6720], [-80.1300, 27.6725], [-80.1295, 27.6730],
                [-80.1290, 27.6735], [-80.1285, 27.6740], [-80.1280, 27.6745],
                [-80.1275, 27.6750], [-80.1270, 27.6755], [-80.1265, 27.6760],
                [-80.1260, 27.6765], [-80.1255, 27.6770], [-80.1250, 27.6775],
                [-80.1245, 27.6780], [-80.1240, 27.6785], [-80.1235, 27.6790],
                [-80.1230, 27.6795], [-80.1225, 27.6800], [-80.1220, 27.6805],
                [-80.1215, 27.6810], [-80.1210, 27.6815], [-80.1205, 27.6820],
                [-80.1200, 27.6825], [-80.1195, 27.6830], [-80.1190, 27.6835],
                [-80.1185, 27.6840], [-80.1180, 27.6845], [-80.1175, 27.6850],
                [-80.1170, 27.6855], [-80.1165, 27.6860], [-80.1160, 27.6865],
                [-80.1155, 27.6870], [-80.1150, 27.6875], [-80.1145, 27.6880],
                [-80.1140, 27.6885], [-80.1135, 27.6890], [-80.1130, 27.6895],
                [-80.1125, 27.6900], [-80.1120, 27.6905], [-80.1115, 27.6910],
                [-80.1110, 27.6915], [-80.1105, 27.6920], [-80.1100, 27.6925],
                [-80.1095, 27.6930], [-80.1090, 27.6935], [-80.1085, 27.6940],
                [-80.1080, 27.6945], [-80.1075, 27.6950], [-80.1070, 27.6955],
                [-80.1065, 27.6960], [-80.1060, 27.6965], [-80.1055, 27.6970],
                [-80.1050, 27.6975], [-80.1045, 27.6980], [-80.1040, 27.6985],
                [-80.1035, 27.6990], [-80.1030, 27.6995], [-80.1025, 27.7000],
                [-80.1020, 27.7005], [-80.1015, 27.7010], [-80.1010, 27.7015],
                [-80.1005, 27.7020], [-80.1000, 27.7025], [-80.0995, 27.7030],
                [-80.0990, 27.7035], [-80.0985, 27.7040], [-80.0980, 27.7045],
                [-80.0975, 27.7050], [-80.0970, 27.7055], [-80.0965, 27.7060],
                [-80.0960, 27.7065], [-80.0955, 27.7070], [-80.0950, 27.7075],
                [-80.0945, 27.7080], [-80.0940, 27.7085], [-80.0935, 27.7090],
                [-80.0930, 27.7095], [-80.0925, 27.7100], [-80.0920, 27.7105],
                [-80.0915, 27.7110], [-80.0910, 27.7115], [-80.0905, 27.7120],
                [-80.0900, 27.7125], [-80.0895, 27.7130], [-80.0890, 27.7135],
                [-80.0885, 27.7140], [-80.0880, 27.7145], [-80.0875, 27.7150],
                [-80.0870, 27.7155], [-80.0865, 27.7160], [-80.0860, 27.7165],
                [-80.0855, 27.7170], [-80.0850, 27.7175], [-80.0845, 27.7180],
                [-80.0840, 27.7185], [-80.0835, 27.7190], [-80.0830, 27.7195],
                [-80.0825, 27.7200], [-80.0820, 27.7205], [-80.0815, 27.7210],
                [-80.0810, 27.7215], [-80.0805, 27.7220], [-80.0800, 27.7225],
                [-80.0795, 27.7230], [-80.0790, 27.7235], [-80.0785, 27.7240],
                [-80.0780, 27.7245], [-80.0775, 27.7250], [-80.0770, 27.7255],
                [-80.0765, 27.7260], [-80.0760, 27.7265], [-80.0755, 27.7270],
                [-80.0750, 27.7275], [-80.0745, 27.7280], [-80.0740, 27.7285],
                [-80.0735, 27.7290], [-80.0730, 27.7295], [-80.0725, 27.7300],
                [-80.0720, 27.7305], [-80.0715, 27.7310], [-80.0710, 27.7315],
                [-80.0705, 27.7320], [-80.0700, 27.7325], [-80.0695, 27.7330],
                [-80.0690, 27.7335], [-80.0685, 27.7340], [-80.0680, 27.7345],
                [-80.0675, 27.7350], [-80.0670, 27.7355], [-80.0665, 27.7360],
                [-80.0660, 27.7365], [-80.0655, 27.7370], [-80.0650, 27.7375],
                [-80.0645, 27.7380], [-80.0640, 27.7385], [-80.0635, 27.7390],
                [-80.0630, 27.7395], [-80.0625, 27.7400], [-80.0620, 27.7405],
                [-80.0615, 27.7410], [-80.0610, 27.7415], [-80.0605, 27.7420],
                [-80.0600, 27.7425], [-80.0595, 27.7430], [-80.0590, 27.7435],
                [-80.0585, 27.7440], [-80.0580, 27.7445], [-80.0575, 27.7450],
                [-80.0570, 27.7455], [-80.0565, 27.7460], [-80.0560, 27.7465],
                [-80.0555, 27.7470], [-80.0550, 27.7475], [-80.0545, 27.7480],
                [-80.0540, 27.7485], [-80.0535, 27.7490], [-80.0530, 27.7495],
                [-80.0525, 27.7500], [-80.0520, 27.7505], [-80.0515, 27.7510],
                [-80.0510, 27.7515], [-80.0505, 27.7520], [-80.0500, 27.7525],
                [-80.0495, 27.7530], [-80.0490, 27.7535], [-80.0485, 27.7540],
                [-80.0480, 27.7545], [-80.0475, 27.7550], [-80.0470, 27.7555],
                [-80.0465, 27.7560], [-80.0460, 27.7565], [-80.0455, 27.7570],
                [-80.0450, 27.7575], [-80.0445, 27.7580], [-80.0440, 27.7585],
                [-80.0435, 27.7590], [-80.0430, 27.7595], [-80.0425, 27.7600],
                [-80.0420, 27.7605], [-80.0415, 27.7610], [-80.0410, 27.7615],
                [-80.0405, 27.7620], [-80.0400, 27.7625], [-80.0395, 27.7630],
                [-80.0390, 27.7635], [-80.0385, 27.7640], [-80.0380, 27.7645],
                [-80.0375, 27.7650], [-80.0370, 27.7655], [-80.0365, 27.7660],
                [-80.0360, 27.7665], [-80.0355, 27.7670], [-80.0350, 27.7675],
                [-80.0345, 27.7680], [-80.0340, 27.7685], [-80.0335, 27.7690],
                [-80.0330, 27.7695], [-80.0325, 27.7700], [-80.0320, 27.7705],
                [-80.0315, 27.7710], [-80.0310, 27.7715], [-80.0305, 27.7720],
                [-80.0300, 27.7725], [-80.0295, 27.7730], [-80.0290, 27.7735],
                [-80.0285, 27.7740], [-80.0280, 27.7745], [-80.0275, 27.7750],
                [-80.0270, 27.7755], [-80.0265, 27.7760], [-80.0260, 27.7765],
                [-80.0255, 27.7770], [-80.0250, 27.7775], [-80.0245, 27.7780],
                [-80.0240, 27.7785], [-80.0235, 27.7790], [-80.0230, 27.7795],
                [-80.0225, 27.7800], [-80.0220, 27.7805], [-80.0215, 27.7810],
                [-80.0210, 27.7815], [-80.0205, 27.7820], [-80.0200, 27.7825],
                [-80.0195, 27.7830], [-80.0190, 27.7835], [-80.0185, 27.7840],
                [-80.0180, 27.7845], [-80.0175, 27.7850], [-80.0170, 27.7855],
                [-80.0165, 27.7860], [-80.0160, 27.7865], [-80.0155, 27.7870],
                [-80.0150, 27.7875], [-80.0145, 27.7880], [-80.0140, 27.7885],
                [-80.0135, 27.7890], [-80.0130, 27.7895], [-80.0125, 27.7900],
                [-80.0120, 27.7905], [-80.0115, 27.7910], [-80.0110, 27.7915],
                [-80.0105, 27.7920], [-80.0100, 27.7925], [-80.0095, 27.7930],
                [-80.0090, 27.7935], [-80.0085, 27.7940], [-80.0080, 27.7945],
                [-80.0075, 27.7950], [-80.0070, 27.7955], [-80.0065, 27.7960],
                [-80.0060, 27.7965], [-80.0055, 27.7970], [-80.0050, 27.7975],
                [-80.0045, 27.7980], [-80.0040, 27.7985], [-80.0035, 27.7990],
                [-80.0030, 27.7995], [-80.0025, 27.8000], [-80.0020, 27.8005],
                [-80.0015, 27.8010], [-80.0010, 27.8015], [-80.0005, 27.8020],
                [-80.0000, 27.8025], [-79.9995, 27.8030], [-79.9990, 27.8035],
                [-79.9985, 27.8040], [-79.9980, 27.8045], [-79.9975, 27.8050],
                [-79.9970, 27.8055], [-79.9965, 27.8060], [-79.9960, 27.8065],
                [-79.9955, 27.8070], [-79.9950, 27.8075], [-79.9945, 27.8080],
                [-79.9940, 27.8085], [-79.9935, 27.8090], [-79.9930, 27.8095],
                [-79.9925, 27.8100], [-79.9920, 27.8105], [-79.9915, 27.8110],
                [-79.9910, 27.8115], [-79.9905, 27.8120], [-79.9900, 27.8125],
                [-79.9895, 27.8130], [-79.9890, 27.8135], [-79.9885, 27.8140],
                [-79.9880, 27.8145], [-79.9875, 27.8150], [-79.9870, 27.8155],
                [-79.9865, 27.8160], [-79.9860, 27.8165], [-79.9855, 27.8170],
                [-79.9850, 27.8175], [-79.9845, 27.8180], [-79.9840, 27.8185],
                [-79.9835, 27.8190], [-79.9830, 27.8195], [-79.9825, 27.8200],
                [-79.9820, 27.8205], [-79.9815, 27.8210], [-79.9810, 27.8215],
                [-79.9805, 27.8220], [-79.9800, 27.8225], [-79.9795, 27.8230],
                [-79.9790, 27.8235], [-79.9785, 27.8240], [-79.9780, 27.8245],
                [-79.9775, 27.8250], [-79.9770, 27.8255], [-79.9765, 27.8260],
                [-79.9760, 27.8265], [-79.9755, 27.8270], [-79.9750, 27.8275],
                [-79.9745, 27.8280], [-79.9740, 27.8285], [-79.9735, 27.8290],
                [-79.9730, 27.8295], [-79.9725, 27.8300], [-79.9720, 27.8305],
                [-79.9715, 27.8310], [-79.9710, 27.8315], [-79.9705, 27.8320],
                [-79.9700, 27.8325], [-79.9695, 27.8330], [-79.9690, 27.8335],
                [-79.9685, 27.8340], [-79.9680, 27.8345], [-79.9675, 27.8350],
                [-79.9670, 27.8355], [-79.9665, 27.8360], [-79.9660, 27.8365],
                [-79.9655, 27.8370], [-79.9650, 27.8375], [-79.9645, 27.8380],
                [-79.9640, 27.8385], [-79.9635, 27.8390], [-79.9630, 27.8395],
                [-79.9625, 27.8400], [-79.9620, 27.8405], [-79.9615, 27.8410],
                [-79.9610, 27.8415], [-79.9605, 27.8420], [-79.9600, 27.8425],
                [-79.9595, 27.8430], [-79.9590, 27.8435], [-79.9585, 27.8440],
                [-79.9580, 27.8445], [-79.9575, 27.8450], [-79.9570, 27.8455],
                [-79.9565, 27.8460], [-79.9560, 27.8465], [-79.9555, 27.8470],
                [-79.9550, 27.8475], [-79.9545, 27.8480], [-79.9540, 27.8485],
                [-79.9535, 27.8490], [-79.9530, 27.8495], [-79.9525, 27.8500],
                [-79.9520, 27.8505], [-79.9515, 27.8510], [-79.9510, 27.8515],
                [-79.9505, 27.8520], [-79.9500, 27.8525], [-79.9495, 27.8530],
                [-79.9490, 27.8535], [-79.9485, 27.8540], [-79.9480, 27.8545],
                [-79.9475, 27.8550], [-79.9470, 27.8555], [-79.9465, 27.8560],
                [-79.9460, 27.8565], [-79.9455, 27.8570], [-79.9450, 27.8575],
                [-79.9445, 27.8580], [-79.9440, 27.8585], [-79.9435, 27.8590],
                [-79.9430, 27.8595], [-79.9425, 27.8600], [-79.9420, 27.8605],
                [-79.9415, 27.8610], [-79.9410, 27.8615], [-79.9405, 27.8620],
                [-79.9400, 27.8625], [-79.9395, 27.8630], [-79.9390, 27.8635],
                [-79.9385, 27.8640], [-79.9380, 27.8645], [-79.9375, 27.8650],
                [-79.9370, 27.8655], [-79.9365, 27.8660], [-79.9360, 27.8665],
                [-79.9355, 27.8670], [-79.9350, 27.8675], [-79.9345, 27.8680],
                [-79.9340, 27.8685], [-79.9335, 27.8690], [-79.9330, 27.8695],
                [-79.9325, 27.8700], [-79.9320, 27.8705], [-79.9315, 27.8710],
                [-79.9310, 27.8715], [-79.9305, 27.8720], [-79.9300, 27.8725],
                [-79.9295, 27.8730], [-79.9290, 27.8735], [-79.9285, 27.8740],
                [-80.3478, 27.4547]  # Close the loop
            ]
        },
        "length_m": 6019.0,
        "sectors": [
            {"id": "s1", "start_s": 0.0, "end_s": 2006.0, "name": "Sector 1"},
            {"id": "s2", "start_s": 2006.0, "end_s": 4012.0, "name": "Sector 2"},
            {"id": "s3", "start_s": 4012.0, "end_s": 6019.0, "name": "Sector 3"}
        ],
        "elevation_profile": [
            {"s": 0.0, "elev": 12.3}, {"s": 1000.0, "elev": 15.2}, {"s": 2000.0, "elev": 18.1},
            {"s": 3000.0, "elev": 16.5}, {"s": 4000.0, "elev": 14.8}, {"s": 5000.0, "elev": 13.2},
            {"s": 6019.0, "elev": 12.3}
        ]
    }
}

# Generate mock geometry for other tracks
for track_id in ["cota", "sonoma", "barber", "indianapolis", "road-america", "vir"]:
    if track_id not in MOCK_TRACK_GEOMETRY:
        # Create a simple oval/loop for demo
        import random
        random.seed(hash(track_id))
        base_lat = 30.0 + random.random() * 20.0
        base_lon = -100.0 + random.random() * 20.0
        coords = []
        for i in range(100):
            angle = 2 * math.pi * i / 100
            lat = base_lat + 0.01 * math.cos(angle)
            lon = base_lon + 0.01 * math.sin(angle)
            coords.append([lon, lat])
        coords.append(coords[0])  # Close loop
        
        MOCK_TRACK_GEOMETRY[track_id] = {
            "centerline_geojson": {"type": "LineString", "coordinates": coords},
            "length_m": 5000.0 + random.random() * 2000.0,
            "sectors": [
                {"id": "s1", "start_s": 0.0, "end_s": 1666.0, "name": "Sector 1"},
                {"id": "s2", "start_s": 1666.0, "end_s": 3333.0, "name": "Sector 2"},
                {"id": "s3", "start_s": 3333.0, "end_s": 5000.0, "name": "Sector 3"}
            ],
            "elevation_profile": [
                {"s": 0.0, "elev": 10.0 + random.random() * 10.0},
                {"s": 2500.0, "elev": 15.0 + random.random() * 10.0},
                {"s": 5000.0, "elev": 10.0 + random.random() * 10.0}
            ]
        }


def haversine_distance(lat1: float, lon1: float, lat2: float, lon2: float) -> float:
    """Calculate distance between two points in meters"""
    R = 6371000  # Earth radius in meters
    dlat = math.radians(lat2 - lat1)
    dlon = math.radians(lon2 - lon1)
    a = math.sin(dlat/2)**2 + math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) * math.sin(dlon/2)**2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
    return R * c


def find_closest_point_on_line(point: Tuple[float, float], line_coords: List[List[float]]) -> Tuple[float, float, float]:
    """
    Find closest point on line to given point
    Returns: (closest_lat, closest_lon, distance_along_line)
    """
    min_dist = float('inf')
    closest_point = None
    closest_s = 0.0
    cumulative_s = 0.0
    
    point_lat, point_lon = point
    
    for i in range(len(line_coords) - 1):
        p1_lon, p1_lat = line_coords[i]
        p2_lon, p2_lat = line_coords[i + 1]
        
        # Segment length
        seg_len = haversine_distance(p1_lat, p1_lon, p2_lat, p2_lon)
        
        # Project point onto segment
        # Vector from p1 to p2
        dx = p2_lon - p1_lon
        dy = p2_lat - p1_lat
        
        # Vector from p1 to point
        px = point_lon - p1_lon
        py = point_lat - p1_lat
        
        # Projection parameter
        t = max(0.0, min(1.0, (px * dx + py * dy) / (dx * dx + dy * dy) if (dx * dx + dy * dy) > 0 else 0.0))
        
        # Closest point on segment
        closest_lon = p1_lon + t * dx
        closest_lat = p1_lat + t * dy
        
        # Distance from point to closest point on segment
        dist = haversine_distance(point_lat, point_lon, closest_lat, closest_lon)
        
        if dist < min_dist:
            min_dist = dist
            closest_point = (closest_lat, closest_lon)
            closest_s = cumulative_s + t * seg_len
        
        cumulative_s += seg_len
    
    return closest_point[0], closest_point[1], closest_s


def calculate_curvature(line_coords: List[List[float]], s: float, window: float = 50.0) -> float:
    """Calculate curvature at point s along the line"""
    # Simplified curvature calculation
    # In production, use proper geometric curvature
    return 0.003 + (s % 1000.0) / 100000.0  # Mock curvature


class MapService:
    """Map and geospatial matching service"""
    
    def __init__(self):
        self.track_cache = {}
        logger.info("MapService initialized")
    
    def get_track_geometry(self, track_id: str) -> Optional[Dict]:
        """Get track geometry (centerline, sectors, elevation)"""
        if track_id in self.track_cache:
            return self.track_cache[track_id]
        
        # Try to load from file or use mock
        geometry = MOCK_TRACK_GEOMETRY.get(track_id)
        if geometry:
            self.track_cache[track_id] = geometry
            return geometry
        
        logger.warning(f"Track geometry not found for {track_id}, using default mock")
        # Return a default mock
        return MOCK_TRACK_GEOMETRY.get("sebring")
    
    def match_points(self, track_id: str, points: List[Dict]) -> List[Dict]:
        """
        Match GPS points to track centerline
        Returns enriched points with s, offset, sector, curvature
        """
        geometry = self.get_track_geometry(track_id)
        if not geometry:
            raise ValueError(f"Track {track_id} not found")
        
        centerline = geometry["centerline_geojson"]["coordinates"]
        length_m = geometry["length_m"]
        sectors = geometry["sectors"]
        
        matches = []
        for point in points:
            lat = point.get("lat")
            lon = point.get("lon")
            ts = point.get("ts")
            
            if lat is None or lon is None:
                continue
            
            # Find closest point on centerline
            closest_lat, closest_lon, s = find_closest_point_on_line((lat, lon), centerline)
            
            # Calculate lateral offset
            offset_m = haversine_distance(lat, lon, closest_lat, closest_lon)
            
            # Determine sector
            sector = "s1"
            for sec in sectors:
                if sec["start_s"] <= s < sec["end_s"]:
                    sector = sec["id"]
                    break
            
            # Calculate curvature
            curvature = calculate_curvature(centerline, s)
            
            # Get elevation (interpolate from profile)
            elevation = self._get_elevation_at_s(geometry["elevation_profile"], s)
            
            matches.append({
                "ts": ts,
                "lat": lat,
                "lon": lon,
                "s": round(s, 2),
                "offset_m": round(offset_m, 2),
                "sector": sector,
                "arc_kappa": round(curvature, 6),
                "elevation": round(elevation, 1),
                "matched_lat": round(closest_lat, 6),
                "matched_lon": round(closest_lon, 6)
            })
        
        return matches
    
    def _get_elevation_at_s(self, elevation_profile: List[Dict], s: float) -> float:
        """Interpolate elevation at distance s"""
        if not elevation_profile:
            return 0.0
        
        for i in range(len(elevation_profile) - 1):
            s1, elev1 = elevation_profile[i]["s"], elevation_profile[i]["elev"]
            s2, elev2 = elevation_profile[i + 1]["s"], elevation_profile[i + 1]["elev"]
            
            if s1 <= s <= s2:
                if s2 == s1:
                    return elev1
                t = (s - s1) / (s2 - s1)
                return elev1 + t * (elev2 - elev1)
        
        return elevation_profile[-1]["elev"]
    
    def enrich_telemetry(self, track_id: str, samples: List[Dict]) -> List[Dict]:
        """Enrich telemetry samples with spatial data"""
        matches = self.match_points(track_id, samples)
        
        enriched = []
        for i, sample in enumerate(samples):
            if i < len(matches):
                match = matches[i]
                enriched_sample = sample.copy()
                enriched_sample.update({
                    "s": match["s"],
                    "sector": match["sector"],
                    "elevation": match["elevation"],
                    "curvature": match["arc_kappa"],
                    "offset_m": match["offset_m"],
                    "on_racing_line": match["offset_m"] < 2.0  # Within 2m of centerline
                })
                enriched.append(enriched_sample)
            else:
                enriched.append(sample)
        
        return enriched


# Singleton instance
map_service = MapService()

